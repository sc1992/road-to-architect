# 权限 Study Notes [^ history version]

@(Notes)[权限, Notes]

> VICTORY LOVES PREPARATION.

[^ history version]: 
> 2017年03月18日 下午06:54:09

[TOC]

***
## 〇、思维导图
- **`SUMMARY：`**

> *注意*
> -  

<br>	
## 一、简介

### 1.1 概念
- **`SUMMARY：`对用户访问系统的控制，包括用户身份认证和授权两部分。**
- 基本上涉及到用户参与的系统都要进行权限管理；
- 权限管理实现**对用户访问系统的控制**，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源，权限管理**属于系统安全的范畴**；
- 权限管理包括用户身份**认证**和**授权**两部分，简称**认证授权**。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。

	> *注意*
	> - **认证**：（`SUMMARY:`确认操作者身份的过程）即身份认证，也称为“身份验证”或“身份鉴别”，*是指在计算机及计算机网络系统中确认操作者身份的过程，从而确定该用户是否具有对某种资源的访问和使用权限，*进而使计算机和网络系统的访问策略能够可靠、有效地执行，防止攻击者假冒合法用户获得资源的访问权限，保证系统和数据的安全，以及授权访问者的合法利益。
	> - **授权**（`SUMMARY:` 授予操作权限给用户）：在计算机及计算机系统中是指授予操作权限给用户。
	> - **加密**（`SUMMARY:`明文到暗文）：明文到暗文。
	> - **会话管理**（`SUMMARY:`用户会话活动和计算机系统跟踪过程）：在人机交互，会话管理是保持用户的整个会话活动的互动与计算机系统跟踪过程。

### 1.2 认证
#### 1.2.1 概念
- **`SUMMARY：`判断一个用户是否为合法用户的处理过程。**
- 就是判断一个用户是否为合法用户的处理过程；
- 最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确；
- 对于采用指纹等系统，则出示指纹；
- 对于硬件`Key`等刷卡系统，则需要刷卡；
- 基于证书验证方法。

#### 1.2.2 用户名密码认证流程
*`img.`用户名密码认证流程：*<br>![][1]

#### 1.2.3 关键对象
- **`SUMMARY：`主体在进行身份认证的时候要验证身份信息和凭证信息。**
##### 1.2.3.1 主体
- **`SUMMARY：`访问系统的用户。**
- 访问系统的用户，主体可以是用户、程序等，进行认证的都称为主体。

##### 1.2.3.2 身份信息
- **`SUMMARY：`进行身份认证的标识。**
- 是主体（`subject`）进行身份认证的标识，标识必须具有唯一性，如用户名、手机号、邮箱地址等；
- **一个主体可以有多个身份，但是必须有一个主身份（`Primary` `Principal`）**。

##### 1.2.3.3 凭证信息
- **`SUMMARY：`只有主体自己知道的安全信息。**
- 是只有主体自己知道的安全信息，如密码、证书等。

### 1.3 授权
#### 1.3.1 概念
- **`SUMMARY：`即访问控制，控制谁能访问哪些资源。**
- 即访问控制，控制谁能访问哪些资源；
- 主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限则无法访问。

#### 1.3.2 授权流程
- *`img.`下图中橙色为授权流程（蓝色为认证过程）：*<br>![][2]

#### 1.3.3 关键对象
- 授权可简单理解为`who`对`what`（`which`）进行`How`操作：
- `Who`
	- 即主体（`Subject`），主体需要访问系统中的资源。
- `What`
	- 即资源（`Resource`），如系统菜单、页面、按钮、类方法、系统商品信息等。资源包括资源类型和资源实例，比如商品信息为资源类型，类型为`t01`的商品为资源实例，编号为`001`的商品信息也属于资源实例。
- `How`
	- 权限/许可（`Permission`），规定了主体对资源的操作许可，权限离开资源没有意义，如用户查询权限、用户添加权限、某个类方法的调用权限、编号为`001`用户的修改权限等，通过权限可知主体对哪些资源都有哪些操作许可。
权限分为粗颗粒和细颗粒，粗颗粒权限是指对资源类型的权限，细颗粒权限是对资源实例的权限。
- *`img.`主体、资源、权限关系如下图：*<br>![][3]

#### 1.3.4 权限模型
- 对上节中的主体、资源、权限通过数据模型表示。
- 主体（账号、密码）
- 资源（资源名称、访问地址）
- 权限（权限名称、资源`id`）
- 角色（角色名称）
- 角色和权限关系（角色`id`、权限`id`）
- 主体和角色关系（主体`id`、角色`id`）
- *`img.`如下图：*<br>![][4]
- 通常企业开发中将资源和权限表合并为一张权限表，如下：
- 资源（资源名称、访问地址）
- 权限（权限名称、资源`id）
- 合并为：
- 权限（权限名称、资源名称、资源访问地址）权限是针对于资源来说的
- *`img.`如图：*<br>![][5]
- 上图常被称为权限管理的通用模型，不过企业在开发中根据系统自身的特点还会对上图进行修改，但是用户、角色、权限、用户角色关系、角色权限关系是需要去理解的。

#### 1.3.5 权限分配
- **`SUMMARY：`对主体分配权限，主体只允许在权限范围内对资源进行操作。**
- 对主体分配权限，主体只允许在权限范围内对资源进行操作，比如：
	- 对`u01`用户分配商品修改权限，`u01`用户只能对商品进行修改。
- 权限分配的数据通常需要持久化，根据上边的数据模型创建表并将用户的权限信息存储在数据库中。

#### 1.3.6 权限控制
- 用户拥有了权限即可操作权限范围内的资源，系统不知道主体是否具有访问权限需要对用户的访问进行控制。

##### 1.3.6.1 基于角色的访问控制
- **`SUMMARY：`基于角色的访问控制（`Role-Based` `Access` `Control`）是以角色为中心进行访问控制。**
- `RBAC`基于角色的访问控制（`Role-Based` `Access` `Control`）是以角色为中心进行访问控制，比如：
	- 主体的角色为总经理可以查询企业运营报表，查询员工工资信息等
- *`img.`访问控制流程如下：*<br>![][6]
- 上图中的判断逻辑代码可以理解为：

	``` java
	if(主体.hasRole("总经理角色id")){
		查询工资
	}
	```
	
- 缺点
	- 以角色进行访问控制粒度较粗，如果上图中查询工资所需要的角色变化为总经理和部门经理，此时就需要修改判断逻辑为“判断主体的角色是否是总经理或部门经理”，系统可扩展性差。
- 修改代码如下：

	``` java
	if(主体.hasRole("总经理角色id") ||  主体.hasRole("部门经理角色id")){
		查询工资
	}
	```

##### 1.3.6.2 基于资源的访问控制
- **`SUMMARY：`基于资源的访问控制（`Resource-Based` `Access` `Control`）是以资源为中心进行访问控制。**
- `RBAC`基于资源的访问控制（`Resource-Based` `Access` `Control`）是以资源为中心进行访问控制，比如：
	- 主体必须具有查询工资权限才可以查询员工工资信息等，访问控制流程如下：
- 上图中的判断逻辑代码可以理解为：

	``` java
	if(主体.hasPermission("查询工资权限标识")){
		查询工资
	}
	```

- 优点
	- 系统设计时定义好查询工资的权限标识，即使查询工资所需要的角色变化为总经理和部门经理也只需要将“查询工资信息权限”添加到“部门经理角色”的权限列表中，判断逻辑不用修改，系统可扩展性强。

<br>		 
## 二、解决方案

### 2.1 粗颗粒度和细颗粒度
#### 2.1.1 什么是粗颗粒度和细颗粒度
- **`SUMMARY：`资源类型的管理称为粗颗粒度权限管理，资源实例的控制称为细颗粒度权限管理。**
- 对**资源类型的管理称为粗颗粒度权限管理**，即只控制到菜单、按钮、方法，粗粒度的例子比如：
	- 用户具有用户管理的权限，具有导出订单明细的权限。
- 对**资源实例的控制称为细颗粒度权限管理**，即控制到数据级别的权限，比如：
	- 用户只允许修改本部门的员工信息，用户只允许导出自己创建的订单明细。

#### 2.1.2 如何实现粗颗粒度和细颗粒度
- **`SUMMARY：`资源类型的管理称为粗颗粒度权限管理，资源实例的控制称为细颗粒度权限管理。**
- 对于粗颗粒度的权限管理可以很容易做系统架构级别的功能，即系统功能操作使用统一的粗颗粒度的权限管理。
- 对于细颗粒度的权限管理不建议做成系统架构级别的功能，因为对数据级别的控制是系统的业务需求（细颗粒度更偏向业务逻辑），随着业务需求的变更业务功能变化的可能性很大，建议对数据级别的权限控制在业务层个性化开发，比如：
	- 用户只允许修改自己创建的商品信息可以在`service`接口添加校验实现，`service`接口需要传入当前操作人的标识，与商品信息创建人标识对比，不一致则不允许修改商品信息。

### 2.2 基于URL拦截
- **`SUMMARY：`将系统操作的每个`url`配置在权限表中，将权限对应到角色，将角色分配给用户，用户访问系统功能通过`Filter`进行过滤，过滤器获取到用户访问的`url`，只要访问的`url`是用户分配角色中的`url`则放行继续访问。**
- 基于`url`拦截是企业中常用的权限管理方法，实现思路是：
	- 将系统操作的每个`url`配置在权限表中，将权限对应到角色，将角色分配给用户，用户访问系统功能通过`Filter`进行过滤，过滤器获取到用户访问的`url`，只要访问的`url`是用户分配角色中的`url`则放行继续访问。
- *`img.`如下图：*<br>![][7]

### 2.3 使用权限管理框架
- **`SUMMARY：`权限管理框架提供了完善的认证和授权功能，使用权限管理框架完成权限管理功能的开发可以节省系统开发时间，有利于系统扩展维护。**
- 对于权限管理基本上每个系统都有，使用权限管理框架完成权限管理功能的开发可以节省系统开发时间，并且权限管理框架提供了完善的认证和授权功能有利于系统扩展维护，但是学习权限管理框架是需要成本的，所以选择一款简单高效的权限管理框架显得非常重要。
- **对于粗粒度的权限管理：**
	- 建议使用优秀权限管理框架来实现，节省开发成本，提高开发效率。
- **对于细粒度的权限管理：**
	- 可以使用基于`url`的拦截方式（常用）。


<br>		 
## 三、注意事项

[1]: http://p1.bqimg.com/567571/54b2418e0b075833.png
[2]: http://p1.bpimg.com/567571/ad146caef66b2cb5.png
[3]: http://p1.bpimg.com/567571/9e4db83b9e83f8a0.png
[4]: http://i1.piimg.com/567571/c39ab9132a5f4127.png 
[5]: http://p1.bpimg.com/567571/12f44b42d778b688.png
[6]: http://i1.piimg.com/567571/2bde80d6c4869e03.png
[7]: http://p1.bpimg.com/567571/40267c542c4fd55e.png
[8]: http://p1.bpimg.com/567571/5d66b324984610e1.png
[9]: http://i1.piimg.com/567571/7fec4c594acdedf5.png
[10]: http://p1.bpimg.com/567571/823f46490953b2fc.png
[11]: http://i1.piimg.com/567571/be7d7b25d9c7488d.png
[12]: http://i1.piimg.com/567571/29c8c56fe447bc1b.png
[13]: http://i1.piimg.com/567571/619c5030a8f33896.png